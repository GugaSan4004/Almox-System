import re
import shutil
import datetime
import webbrowser

from flask_socketio import SocketIO
from static.py.screen import screen
from static.py.cam_service import camera
from static.py import imareocr, return_generator, sqlite_core
from flask import Flask, request, jsonify, render_template, send_from_directory, send_file



# ################################ #
#      Initializing Essencial      #
#             Modules              #
# ################################ # 



# FOLDER = r"\\192.168.7.252\dados\OPERACOES\13-ALMOXARIFADO\0 - Sistema Almox"
FOLDER = r"C:\Users\GUGA4\Desktop\almox-system"

sqlite = sqlite_core.init(FOLDER)

tools_db = sqlite_core.init.tools(sqlite)
mails_db = sqlite_core.init.mails(sqlite)
vision_db = sqlite_core.init.vision(sqlite)

imgReader = imareocr.init(FOLDER, vision_db)
returngen = return_generator.init(FOLDER)


app = Flask(__name__)

Socket = SocketIO(
    app,
    async_mode="eventlet",
    ping_interval=25,
    ping_timeout=60,
    cors_allowed_origins="*"
)

# ################################ #
#          Setting Global          #
#            Variables             #
# ################################ # 



lastImage = ""

meses = {
    "01": "jan",
    "02": "fev",
    "03": "mar",
    "04": "abr",
    "05": "mai",
    "06": "jun",
    "07": "jul",
    "08": "ago",
    "09": "set",
    "10": "out",
    "11": "nov",
    "12": "dez"
}



# ################################ #
#          Defining Main           #
#              Routes              #
# ################################ # 



with app.app_context():
    print("> Server initiated successfully!")
    webbrowser.open("http://192.168.7.20/tools-loan")

@app.route("/")
def fallback():
    return render_template("mails/mails.html")

@app.route("/tools-loan/")
@app.route("/tools-loan/<subpath>")
def tool_loans(subpath = None):
    if subpath is None or subpath != "registers":
        return render_template("tools-loan/check-out.html")
    else:  
        return render_template("tools-loan/registers.html")

@app.route("/mails")
def mails():
    return render_template("mails/mails.html")

@app.route("/user-ip", methods=["GET"])
def getIp():
    return jsonify({
        "Message": request.remote_addr
    }, 200)

@app.route("/pictures/<path:filename>")
def picture(filename):
    return send_from_directory(FOLDER + r"\pictures", filename)



# ################################ #
#          Routes to the           #
#          Tools-loan Tab          #
# ################################ # 



@app.route("/tools-loan/add-tool", methods=["POST"])
def add_tool():
    data = request.json
    
    if data == None:
        sqlite.log_edit(
            route="/tools-loan/add-tool",
            method="[POST]",
            id=None,
            code=400,
            message="Invalid Code",
            fields_changed=None,
            values=data,
            ip=request.remote_addr
        )
        return jsonify({
            "Message": "Error: Nenhum valor foi passado!"
        }, 400)

    if not (item := tools_db.searchTools(data.get("code"))):
        sqlite.log_edit(
            route="/tools-loan/add-tool",
            method="[POST]",
            id=None,
            code=404,
            message="Code not found",
            fields_changed=None,
            values=data,
            ip=request.remote_addr
        )
        return jsonify({
            "Message": "Error: Código não encontrado!"
        }, 404)
    
    if item[3].lower() == "disponivel":
        type = "saida"
        status = "Emprestado"
    elif item[3].lower() == "emprestado":
        type = "entrada"
        status = "Disponivel"
    
    movements_count = tools_db.getMovementsCount()
    
    photo = camera.capture(str(movements_count).zfill(6))
        
    try:
        tools_db.updateTools(item[0], "status", status)
        
        movement = tools_db.addMovement(
            movements_count, 
            item[0], 
            photo["day"], 
            photo["month"], 
            photo["year"], 
            photo["time"], 
            type
        )
        
        tools_db.updateTools(item[0], "id_movements", movement[0])
    except Exception as e:
        sqlite.log_edit(
            route="/tools-loan/add-tool",
            method="[POST]",
            id=item[0],
            code=500,
            message=e,
            fields_changed=None,
            values=data,
            ip=request.remote_addr
        )
        
        return jsonify({
            "Message": "Erro inesperado!"
        }, 500)
    else:
        sqlite.log_edit(
            route="/tools-loan/add-tool",
            method="[POST]",
            id=item[0],
            code=200,
            message="OK",
            fields_changed='{"tools": "status", "tools_movements": "new", "tools": "id_movements"}',
            values='{"status": "' + status + '", "new": "' + str(movement[0]) + '", "id_movements": "' + str(movement[0]) + '"}',
            ip=request.remote_addr
        )
        
        return jsonify({
            "item": item, 
            "movement": movement,
            "photo": photo
        }, 200)

@app.route("/tools-loan/get-registers", methods=["GET"])
def get_registers():
    
    return jsonify({
        "loaned_tools": tools_db.getAllLoanedItems(),
        "all_movements": tools_db.getAllMovements()
    }, 200)
    
@app.route("/tools-loan/registers/missing", methods=["POST"])
def missing():
    data = request.json
    
    if data:
        tools_db.setToolMissing(data.get("code"))
        sqlite.log_edit(
            route="/tools-loan/registers/missing",
            method="[POST]",
            id=None,
            code=200,
            message="OK",
            fields_changed='{"tools": "id_movements"}',
            values='{"id_movements": "NULL"}',
            ip=request.remote_addr
        )
        return jsonify({
            "Message": "Ok"
        }, 200)
    else:
        sqlite.log_edit(
            route="/tools-loan/registers/missing",
            method="[POST]",
            id=None,
            code=400,
            message="Invalid Values",
            fields_changed=None,
            values=None,
            ip=request.remote_addr
        )
        return jsonify({
            "Message": "Valores invalidos!"
        }, 400)



# ################################ #
#          Routes to the           #
#            mails Tab             # 
# ################################ # 



@app.route("/mails/get-mails", methods=["POST"])
def get_mails():
    data = request.get_json()

    return jsonify({
        "mails": mails_db.getMails(data[0], data[1])
    }, 200)

@app.route("/mails/upload_file", methods=["POST"])
def upload_file():
    try:
        if "file" not in request.files:
            sqlite.log_edit(
                route="/mails/upload_file",
                method="[POST]",
                id=None,
                code=400,
                message="Invalid Values",
                fields_changed=None,
                values=None,
                ip=request.remote_addr
            )
            return jsonify({
                "Message": "Error: Nenhum arquivo enviado!"
            }, 400)
        
        file = request.files["file"]
        
        tmp_path = FOLDER + r"\pictures\mails\temp_image.jpg"
        
        file.save(tmp_path)
        
        global lastImage

        lastImage = tmp_path
        
        extracted_text = imgReader.extractText(tmp_path)


        sqlite.log_edit(
            route="/mails/upload_file",
            method="[POST]",
            id=None,
            code=200,
            message="OK",
            fields_changed='{"global": "lastImage"}',
            values='{"lastImage": "' + lastImage + '", "extracted_text": "' + extracted_text + '"}',
            ip=request.remote_addr
        )
        
        return jsonify(extracted_text)
    
    except Exception as e:
        sqlite.log_edit(
            route="/mails/upload_file",
            method="[POST]",
            id=None,
            code=500,
            message=e,
            fields_changed=None,
            values=None,
            ip=request.remote_addr
        )
        return jsonify(":("), 500
    
@app.route("/mails/update", methods=["POST"])
def update():
    data = request.get_json()

    mail_type = data.get("type")
    date = data.get("date")
    
    if not date:
        sqlite.log_edit(
            route="/mails/update",
            method="[POST]",
            id=None,
            code=400,
            message="Invalid date Value",
            fields_changed=None,
            values=None,
            ip=request.remote_addr
        )
        
        return jsonify({
            "Message": "data inválida"
        }, 400)

    if mail_type == "return":
        items = data.get("items", [])

        if not items:
            sqlite.log_edit(
                route="/mails/update",
                method="[POST]",
                id=None,
                code=400,
                message="Invalid Values",
                fields_changed=None,
                values=None,
                ip=request.remote_addr
            )
            return jsonify({
                "Message": "Nenhuma devolução informada"
            }, 400)

        inserted = []

        for item in items:
            code = item.get("code")
            motivo = item.get("motivo")

            if not code:
                continue

            infos = mails_db.getMails(code, "id")
            
            if not infos:
                continue

            infos = infos[0]

            pname = (
                str(infos[4][:3].upper()) +
                str(infos[2][-5:]) +
                str(infos[0])
            )

            dest_path = FOLDER + r"\pictures\mails\\" + pname + ".jpg"

            shutil.copy(lastImage, dest_path)
            
            mails_db.updatePicture(
                motivo,
                date,
                pname,
                code,
                "returned"
            )

            inserted.append(code)

            sqlite.log_edit(
                route="/mails/update",
                method="[POST]",
                id=item.get("code"),
                code=200,
                message="OK",
                fields_changed='{"mails": ["receive_name", "receive_date", "photo_id", "status"]}',
                values='{"receive_name": "' + motivo + '", "receive_date": "' + date + '", "photo_id": "' + pname + '", "status": "' + code + '"}',
                ip=request.remote_addr
            )
            
        return jsonify({
            "Message": "Devoluções registradas",
            "type": "returns"
        }, 200)
    
    code = data.get("code")
    user = data.get("user")

    if (not code or not re.match(r'^[A-Za-z]{2}\d{9}BR$', str(code).upper())) or not user:
        sqlite.log_edit(
            route="/mails/update",
            method="[POST]",
            id=None,
            code=400,
            message="Invalid Values",
            fields_changed=None,
            values=None,
            ip=request.remote_addr
        )
        
        return jsonify({
            "Message": "Codigo ou Recebedor invalido!"
        }, 400)

    infos = mails_db.getMails(code, "id")
    
    if not infos:
        sqlite.log_edit(
            route="/mails/update",
            method="[POST]",
            id=None,
            code=404,
            message="Mail not found",
            fields_changed=None,
            values=None,
            ip=request.remote_addr
        )
        
        return jsonify({
            "Message": "Correspondência não encontrada"
        }, 404)
    elif infos[0][9].lower() == "shipped":
        sqlite.log_edit(
            route="/mails/update",
            method="[POST]",
            id=None,
            code=409,
            message="Mail already shipped",
            fields_changed=None,
            values=None,
            ip=request.remote_addr
        )
        
        return jsonify({
            "Message": "Correspondência já consta como entregue!"
        }, 409)

    infos = infos[0]

    pname = (
        str(infos[4][:3].upper()) +
        str(infos[2][-5:]) +
        str(infos[0])
    )

    dest_path = FOLDER + r"\pictures\mails\\" + pname + ".jpg"
    
    shutil.move(lastImage, dest_path)

    mails_db.updatePicture(user, date, pname, code, "shipped")

    sqlite.log_edit(
        route="/mails/update",
        method="[POST]",
        id=code,
        code=200,
        message="OK",
        fields_changed='{"mails": ["receive_name", "receive_date", "photo_id", "status"]}',
        values='{"receive_name": "' + user + '", "receive_date": "' + date + '", "photo_id": "' + pname + '", "status": "' + code + '"}',
        ip=request.remote_addr
    )
    
    return jsonify({
        "Message": "Entrega registrada",
        "PictureName": pname
    }, 200)

@app.route("/mails/register", methods=["POST"])
def register():
    data = request.get_json()

    code = data["code"]
    name = data["name"]
    fantasy = data["fantasy"]
    type_ = data["type"]
    status = data["status"]
    priority = data["priority"]
    
    if re.match(r'^[A-Za-z]{2}\d{9}BR$', str(code).upper()):
        if ("unique constraint failed" in str(mails_db.register(str(name), str(code), str(fantasy), str(type_), str(priority), str(status))).lower()):
            sqlite.log_edit(
                route="/mails/register",
                method="[POST]",
                id=code,
                code=409,
                message="unique constraint failed",
                fields_changed=None,
                values=None,
                ip=request.remote_addr
            )

            return jsonify({
                "Message": "Essa correspondencia ja está cadastrada!"
            }, 409)
        else:
            sqlite.log_edit(
                route="/mails/register",
                method="[POST]",
                id=code,
                code=200,
                message="OK",
                fields_changed='{"mails": ["name", "code", "fantasy", "type", "priority", "status"]}',
                values=(
                    '{"name": "' + str(name) +
                    '", "code": "' + str(code) +
                    '", "fantasy": "' + str(fantasy) +
                    '", "type": "' + str(type_) +
                    '", "priority": "' + str(priority) +
                    '", "status": "' + str(status) + '"}'
                ),
                ip=request.remote_addr
            )


            return jsonify({
                "Message": "Registro efetuado com Sucesso!"
            }, 200)
    else:
        sqlite.log_edit(
            route="/mails/register",
            method="[POST]",
            id=code,
            code=400,
            message="Invalid Values",
            fields_changed=None,
            values=None,
            ip=request.remote_addr
        )
        
        return jsonify({
            "Message": "Código de rastreio invalido!"
        }, 400)

@app.route("/mails/update-reception-received", methods=["POST"])
def reception_received():
    data = request.get_json()

    code = data["code"]
    receiver = data["receiver"]
    sender = data["sender"]
    
    if re.match(r'^[A-Za-z]{2}\d{9}BR$', str(code).upper()):
        filteredMails = mails_db.getMails(str(code), 'id')
        if filteredMails:
            filteredMails = filteredMails[0]
            if (filteredMails[6] == None or filteredMails[7] == None):
                mails_db.updateReceiver(str(code), str(receiver), str(sender))

                sqlite.log_edit(
                    route="/mails/update-reception-received",
                    method="[POST]",
                    id=code,
                    code=200,
                    message="OK",
                    fields_changed='{"mails": ["ReceivedOnReceptionBy", "SendedOnReceptionBy", "LeaveReceptionAt", "status"]}',
                    values=(
                        '{"ReceivedOnReceptionBy": "' + str(receiver) +
                        '", "SendedOnReceptionBy": "' + str(sender) +
                        '", "LeaveReceptionAt": "' + datetime.datetime.now().strftime("%d-%m-%Y %H:%M") +
                        '", "status": "almox"}'
                    ),
                    ip=request.remote_addr
                )

                return jsonify({
                    "Message": "Status atualizado com sucesso!"
                }, 200)
            else:
                sqlite.log_edit(
                    route="/mails/update-reception-received",
                    method="[POST]",
                    id=code,
                    code=409,
                    message="mail already shipped",
                    fields_changed=None,
                    values=None,
                    ip=request.remote_addr
                )
                
                return jsonify({
                    "Message": "A correspondencia ja foi coletada!",
                    "Values": [f"Recebedor: {filteredMails[6].title()}" , f"Liberador: {filteredMails[7].title()}", f"Data: {filteredMails[8]}"]
                }, 409)
        else:
            sqlite.log_edit(
                route="/mails/update-reception-received",
                method="[POST]",
                id=code,
                code=404,
                message="mail not found",
                fields_changed=None,
                values=None,
                ip=request.remote_addr
            )
            
            return jsonify({
                "Message": "Correspondencia não encontrada!"
            }, 404)
    else:
        sqlite.log_edit(
            route="/mails/update-reception-received",
            method="[POST]",
            id=code,
            code=422,
            message="Invalid code format",
            fields_changed=None,
            values=None,
            ip=request.remote_addr
        )
        
        return jsonify({
            "Message": "Código de rastreio invalido!"
        }, 422)

@app.route("/mails/update-column", methods=["POST"])
def update_column():
    data = request.get_json()

    code = data.get("code")
    column = data.get("column")
    new_value = data.get("new_value")
    old_value = data.get("old_value")

    try:
        mails_db.update(str(code), str(new_value), str(column))


    except Exception as e:
        sqlite.log_edit(
            route="/mails/update-column",
            method="[POST]",
            id=code,
            code=500,
            message=e,
            fields_changed=None,
            values=None,
            ip=request.remote_addr
        )
        return jsonify({
            "Message": f"Erro não esperado!"
        }, 500)
    else:
        sqlite.log_edit(
            route="/mails/update-column",
            method="[POST]",
            id=code,
            code=200,
            message="OK",
            fields_changed='{"mails", "' + column +'"}',
            values='{"' + column + '", "' + old_value + ' -> ' + new_value + '",}',
            ip=request.remote_addr
        )
        
        return jsonify({
            "Message": "Nome atualizado com sucesso!"
        }, 200)

@app.route("/mails/generate-return", methods=["POST"])
def generate_return():
    data = request.get_json()

    file_path = returngen.generate_return(
        data=data
    )
    
    for code in data:
        mails_db.update(
            code=code,
            value="returned",
            column="status"
        )

    return jsonify({
        "Message": file_path
    }, 200)


# ################################ #
#             SocketIO             #
#              Repass              #
# ################################ # 



@Socket.on("update_pictures")
def update_pictures():
    Socket.emit("update_pictures")




if __name__ == "__main__":
    Socket.run(
        app,
        host="0.0.0.0",
        port=80,
        debug=False
    )